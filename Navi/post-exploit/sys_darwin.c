//
//  sys_darwin.c
//  ios-fuzzer
//
//  Created by Quote on 2021/1/26.
//  Copyright © 2021 Quote. All rights reserved.
//

#include <sys/sysctl.h>
#import <sys/types.h>
#import <sys/stat.h>
#include <mach/machine.h>
#include <string.h>
#include <assert.h>
#import <mach/mach.h>
#import <sys/sysctl.h>
#include <unistd.h>
#include <sys/mman.h>
#include <sys/param.h>
#include <sys/snapshot.h>
#include <dlfcn.h>
#include <sys/stat.h>
#include <sys/mount.h>
#include <copyfile.h>
#include <sys/sysctl.h>
#include <sys/utsname.h>
#include <stdio.h>
#include <pthread.h>

#import <CommonCrypto/CommonDigest.h>
#import <spawn.h>
#include "mycommon.h"



struct exploit_common_s g_exp;


void sys_init(void)
{
    static bool inited = false;
    if (inited) {
        return;
    }
    int err;
    char buf[256];

    size_t oldlen = sizeof(g_exp.physmemsize);
    err = sysctlbyname("hw.memsize", &g_exp.physmemsize, &oldlen, NULL, 0);
    assert(err == 0);
    oldlen = sizeof(g_exp.pagesize);
    err = sysctlbyname("hw.pagesize", &g_exp.pagesize, &oldlen, NULL, 0);
    assert(err == 0);

    oldlen = sizeof(buf);
    err = sysctlbyname("hw.model", buf, &oldlen, NULL, 0);
    assert(err == 0);
    g_exp.model = strdup(buf);
    oldlen = sizeof(buf);
    err = sysctlbyname("kern.osversion", buf, &oldlen, NULL, 0);
    assert(err == 0);
    g_exp.osversion = strdup(buf);
    oldlen = sizeof(buf);
    err = sysctlbyname("kern.osproductversion", buf, &oldlen, NULL, 0);
    assert(err == 0);
    g_exp.osproductversion = strdup(buf);
    oldlen = sizeof(buf);
    err = sysctlbyname("hw.machine", buf, &oldlen, NULL, 0);
    assert(err == 0);
    g_exp.machine = strdup(buf);
    oldlen = sizeof(buf);
    err = sysctlbyname("kern.version", buf, &oldlen, NULL, 0);
    assert(err == 0);
    g_exp.kern_version = strdup(buf);

    inited = true;
}


void print_os_details(void)
{
   // extern char *get_deviceModel(void);
   // util_info("Phiên bản: 2.1RC~UI_1.1");
    printf("[+] Thiết bị: %s\n", g_exp.machine);
    printf("[+] Phiên bản: iOS %s (%s)\n", g_exp.osproductversion, g_exp.osversion);
    printf("[+] Model: %s\n", g_exp.model);
    printf("[+] Page Size: %#llx\n", g_exp.pagesize);
    printf("[+] Ram Size: %.1f MB\n", g_exp.physmemsize / 1024.0 / 1024.0);
    printf("[+] Kernel Version: %s\n", g_exp.kern_version);
    //print("Uptime: %d ngày", (int)getUptime() / 86400);
}

double getUptime() {
    double uptime = 0;
    size_t *size = NULL;
    struct timeval *boottime = NULL;
    size = (size_t *)malloc(sizeof(size_t));
    if (size == NULL) goto out;
    bzero(size, sizeof(size_t));
    *size = sizeof(struct timeval);
    boottime = (struct timeval *)malloc(*size);
    if (boottime == NULL) goto out;
    bzero(boottime, *size);
    int mib[2] = { CTL_KERN, KERN_BOOTTIME };
    if (sysctl(mib, 2, boottime, size, NULL, 0) != ERR_SUCCESS) goto out;
    time_t bsec = boottime->tv_sec, csec = time(NULL);
    uptime = difftime(csec, bsec);
out:
    SafeFreeNULL(size);
    SafeFreeNULL(boottime);
    return uptime;
}
